{"AWSTemplateFormatVersion": "2010-09-09", "Resources": {"ACM011Config": {"Type": "AWS::Config::ConfigRule", "Properties": {"Source": {"Owner": "CUSTOM_LAMBDA", "SourceDetails": [{"EventSource": "aws.config", "MessageType": "ScheduledNotification", "MaximumExecutionFrequency": "TwentyFour_Hours"}], "SourceIdentifier": {"Fn::GetAtt": ["ACM011Lambda", "Arn"]}}, "Description": "Certificates must be signed by a Certificate Authority which is approved by CISO", "ConfigRuleName": "ACM_011"}, "DependsOn": ["ACM011LambdaPermission"]}, "ACM009LambdaPermission": {"Type": "AWS::Lambda::Permission", "Properties": {"Action": "lambda:InvokeFunction", "FunctionName": {"Ref": "ACM009Lambda"}, "Principal": "config.amazonaws.com"}}, "ACM004Lambda": {"Type": "AWS::Lambda::Function", "Properties": {"Code": {"S3Bucket": {"Ref": "BuildsBucketName"}, "S3Key": "ACM_004.zip", "S3ObjectVersion": "PTkmTAvDMJhI.OG2nPEKREZEw.HEdYwS"}, "Role": {"Fn::Join": [":", ["arn:aws:iam:", {"Ref": "AWS::AccountId"}, "role/aab-config-lambda-execution-role"]]}, "FunctionName": "ConfigRule_ACM_004", "Timeout": "300", "Tags": [{"Value": "NL02481", "Key": "Billing code"}, {"Value": "BLK0001850", "Key": "Block ID"}, {"Value": "AAB.SYS.13153", "Key": "OAR/OPR ID"}, {"Value": "CI0001330", "Key": "Business Application CI"}, {"Value": "Production", "Key": "Environment"}, {"Value": "1", "Key": "Confidentiality"}, {"Value": "1", "Key": "Integrity"}, {"Value": "1", "Key": "Availability"}], "Handler": "ACM_004.lambda_handler", "VpcConfig": {"SubnetIds": [{"Fn::ImportValue": "VPCCreate-PrivateSubnet1Id"}, {"Fn::ImportValue": "VPCCreate-PrivateSubnet2Id"}, {"Fn::ImportValue": "VPCCreate-PrivateSubnet3Id"}], "SecurityGroupIds": [{"Fn::ImportValue": "ConfigRules:SecurityGroup:GroupId"}]}, "Runtime": "python2.7", "MemorySize": "128"}, "DependsOn": ["ACM004Log"]}, "ACM009Log": {"Type": "AWS::Logs::LogGroup", "Properties": {"RetentionInDays": 7, "LogGroupName": "/aws/lambda/ConfigRule_ACM_009"}}, "ACM011Lambda": {"Type": "AWS::Lambda::Function", "Properties": {"Code": {"S3Bucket": {"Ref": "BuildsBucketName"}, "S3Key": "ACM_011.zip", "S3ObjectVersion": "y167GvGIzNjuGT34BhvpkNIwu1nKo4.w"}, "Role": {"Fn::Join": [":", ["arn:aws:iam:", {"Ref": "AWS::AccountId"}, "role/aab-config-lambda-execution-role"]]}, "FunctionName": "ConfigRule_ACM_011", "Timeout": "300", "Tags": [{"Value": "NL02481", "Key": "Billing code"}, {"Value": "BLK0001850", "Key": "Block ID"}, {"Value": "AAB.SYS.13153", "Key": "OAR/OPR ID"}, {"Value": "CI0001330", "Key": "Business Application CI"}, {"Value": "Production", "Key": "Environment"}, {"Value": "1", "Key": "Confidentiality"}, {"Value": "1", "Key": "Integrity"}, {"Value": "1", "Key": "Availability"}], "Handler": "ACM_011.lambda_handler", "VpcConfig": {"SubnetIds": [{"Fn::ImportValue": "VPCCreate-PrivateSubnet1Id"}, {"Fn::ImportValue": "VPCCreate-PrivateSubnet2Id"}, {"Fn::ImportValue": "VPCCreate-PrivateSubnet3Id"}], "SecurityGroupIds": [{"Fn::ImportValue": "ConfigRules:SecurityGroup:GroupId"}]}, "Runtime": "python2.7", "MemorySize": "128"}, "DependsOn": ["ACM011Log"]}, "ACM004LambdaPermission": {"Type": "AWS::Lambda::Permission", "Properties": {"Action": "lambda:InvokeFunction", "FunctionName": {"Ref": "ACM004Lambda"}, "Principal": "config.amazonaws.com"}}, "ACM011Alarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"Dimensions": [{"Name": "FunctionName", "Value": {"Ref": "ACM011Lambda"}}], "Namespace": "AWS/Lambda", "Threshold": 0, "MetricName": "Errors", "EvaluationPeriods": 1, "AlarmActions": ["arn:aws:sns:eu-west-1:913545700946:config-rule-lambda-execution-errors"], "AlarmDescription": "An error occured when running check for ACM_011", "Period": 300, "ComparisonOperator": "GreaterThanThreshold", "Statistic": "Sum", "TreatMissingData": "notBreaching"}}, "ACM004Config": {"Type": "AWS::Config::ConfigRule", "Properties": {"Source": {"Owner": "CUSTOM_LAMBDA", "SourceDetails": [{"EventSource": "aws.config", "MessageType": "ScheduledNotification", "MaximumExecutionFrequency": "TwentyFour_Hours"}], "SourceIdentifier": {"Fn::GetAtt": ["ACM004Lambda", "Arn"]}}, "Description": "Check if any ACM Certificates have tags as 'Block ID' and 'Billing code' as per the tagging policy", "ConfigRuleName": "ACM_004"}, "DependsOn": ["ACM004LambdaPermission"]}, "ACM004Alarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"Dimensions": [{"Name": "FunctionName", "Value": {"Ref": "ACM004Lambda"}}], "Namespace": "AWS/Lambda", "Threshold": 0, "MetricName": "Errors", "EvaluationPeriods": 1, "AlarmActions": ["arn:aws:sns:eu-west-1:913545700946:config-rule-lambda-execution-errors"], "AlarmDescription": "An error occured when running check for ACM_004", "Period": 300, "ComparisonOperator": "GreaterThanThreshold", "Statistic": "Sum", "TreatMissingData": "notBreaching"}}, "ACM004Log": {"Type": "AWS::Logs::LogGroup", "Properties": {"RetentionInDays": 7, "LogGroupName": "/aws/lambda/ConfigRule_ACM_004"}}, "ACM009Config": {"Type": "AWS::Config::ConfigRule", "Properties": {"Source": {"Owner": "CUSTOM_LAMBDA", "SourceDetails": [{"EventSource": "aws.config", "MessageType": "ScheduledNotification", "MaximumExecutionFrequency": "TwentyFour_Hours"}], "SourceIdentifier": {"Fn::GetAtt": ["ACM009Lambda", "Arn"]}}, "Description": "Check if any ACM certificates should use Key Algorithm which are compliant with ABN standards. Allowed Key Algorithm are RSA_2048 and EC_prime256v1", "ConfigRuleName": "ACM_009"}, "DependsOn": ["ACM009LambdaPermission"]}, "ACM011Log": {"Type": "AWS::Logs::LogGroup", "Properties": {"RetentionInDays": 7, "LogGroupName": "/aws/lambda/ConfigRule_ACM_011"}}, "ACM011LambdaPermission": {"Type": "AWS::Lambda::Permission", "Properties": {"Action": "lambda:InvokeFunction", "FunctionName": {"Ref": "ACM011Lambda"}, "Principal": "config.amazonaws.com"}}, "ACM009Alarm": {"Type": "AWS::CloudWatch::Alarm", "Properties": {"Dimensions": [{"Name": "FunctionName", "Value": {"Ref": "ACM009Lambda"}}], "Namespace": "AWS/Lambda", "Threshold": 0, "MetricName": "Errors", "EvaluationPeriods": 1, "AlarmActions": ["arn:aws:sns:eu-west-1:913545700946:config-rule-lambda-execution-errors"], "AlarmDescription": "An error occured when running check for ACM_009", "Period": 300, "ComparisonOperator": "GreaterThanThreshold", "Statistic": "Sum", "TreatMissingData": "notBreaching"}}, "ACM009Lambda": {"Type": "AWS::Lambda::Function", "Properties": {"Code": {"S3Bucket": {"Ref": "BuildsBucketName"}, "S3Key": "ACM_009.zip", "S3ObjectVersion": "EqC8Zt.PYX848nSIDrdZjGPGhYfwjnFw"}, "Role": {"Fn::Join": [":", ["arn:aws:iam:", {"Ref": "AWS::AccountId"}, "role/aab-config-lambda-execution-role"]]}, "FunctionName": "ConfigRule_ACM_009", "Timeout": "300", "Tags": [{"Value": "NL02481", "Key": "Billing code"}, {"Value": "BLK0001850", "Key": "Block ID"}, {"Value": "AAB.SYS.13153", "Key": "OAR/OPR ID"}, {"Value": "CI0001330", "Key": "Business Application CI"}, {"Value": "Production", "Key": "Environment"}, {"Value": "1", "Key": "Confidentiality"}, {"Value": "1", "Key": "Integrity"}, {"Value": "1", "Key": "Availability"}], "Handler": "ACM_009.lambda_handler", "VpcConfig": {"SubnetIds": [{"Fn::ImportValue": "VPCCreate-PrivateSubnet1Id"}, {"Fn::ImportValue": "VPCCreate-PrivateSubnet2Id"}, {"Fn::ImportValue": "VPCCreate-PrivateSubnet3Id"}], "SecurityGroupIds": [{"Fn::ImportValue": "ConfigRules:SecurityGroup:GroupId"}]}, "Runtime": "python2.7", "MemorySize": "128"}, "DependsOn": ["ACM009Log"]}}, "Description": "Lambda functions for ACM config rules", "Parameters": {"BuildsBucketName": {"Type": "String", "Description": "The name of S3 bucket with all the builds"}}}