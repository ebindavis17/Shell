{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Create role for block",
    "Metadata": {},
    "Parameters": {
            "BlockId": {
                    "Type": "String",
                    "Description": "Enter the ID of the block",
                    "MinLength": "10"
            },
            "BlockMembersCorporateIds": {
                    "Default": "",
                    "Description": "Comma delimited list of trusted Corporated Ids for billing role",
                    "Type": "CommaDelimitedList"
            }
    },
    "Mappings": {},
    "Conditions": {},
    "Resources": {
            "BlockDeveloperRole": {
                    "Type": "AWS::IAM::Role",
                    "Properties": {
                            "RoleName": {
                                    "Fn::Join": [
                                            "",
                                            [
                                                    {
                                                            "Ref": "BlockId"
                                                    },
                                                    "-dev"
                                            ]
                                    ]
                            },
                            "AssumeRolePolicyDocument": {
                                    "Statement": [
                                            {
                                                    "Action": "sts:AssumeRole",
                                                    "Effect": "Allow",
                                                    "Principal": {
                                                            "AWS": [
                                                                    {
                                                                            "Fn::Join": [
                                                                                    ":",
                                                                                    [
                                                                                            "arn:aws:iam:",
                                                                                            {
                                                                                                    "Ref": "AWS::AccountId"
                                                                                            },
                                                                                            "root"
                                                                                    ]
                                                                            ]
                                                                    }
                                                            ]
                                                    }
                                            }
                                    ],
                                    "Version": "2012-10-17"
                            },
                            "ManagedPolicyArns": [
                                    "arn:aws:iam::aws:policy/ReadOnlyAccess",
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-developer-readOnly-policy"
                                                    ]
                                            ]
                                    },
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-developer-cf-access-policy"
                                                    ]
                                            ]
                                    },
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-developer-deny-VPC-only-policy"
                                                    ]
                                            ]
                                    },
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-cbsp-deny-update-stack"
                                                    ]
                                            ]
                                    }
                            ],
                            "Policies": [
                                    {
                                            "PolicyName": "inline-role-policy",
                                            "PolicyDocument": {
                                                    "Version": "2012-10-17",
                                                    "Statement": [
                                                            {
                                                                    "Sid": "IAMpassRolePolicy",
                                                                    "Action": [
                                                                            "iam:PassRole"
                                                                    ],
                                                                    "Resource": [
                                                                            {
                                                                                    "Fn::Join": [
                                                                                            "",
                                                                                            [
                                                                                                    "arn:aws:iam::",
                                                                                                    {
                                                                                                            "Ref": "AWS::AccountId"
                                                                                                    },
                                                                                                    ":role/",
                                                                                                    {
                                                                                                            "Ref": "BlockId"
                                                                                                    },
                                                                                                    "-dev-cfn"
                                                                                            ]
                                                                                    ]
                                                                            }
                                                                    ],
                                                                    "Effect": "Allow"
                                                            },
                                                            {
                                                                    "Sid": "AppStreamAccessPolicy",
                                                                    "Action": [
                                                                            "appstream:TagResource",
                                                                            "appstream:DeleteImage",
                                                                            "appstream:CreateImageBuilder",
                                                                            "appstream:DeleteImageBuilder",
                                                                            "appstream:StartImageBuilder",
                                                                            "appstream:StopImageBuilder",
                                                                            "appstream:CreateImageBuilderStreamingURL"
                                                                    ],
                                                                    "Effect": "Allow",
                                                                    "Resource": [
                                                                            {
                                                                                    "Fn::Join": [
                                                                                            "",
                                                                                            [
                                                                                                    "arn:aws:appstream:eu-west-1:",
                                                                                                    {
                                                                                                            "Ref": "AWS::AccountId"
                                                                                                    },
                                                                                                    ":image-builder/",
                                                                                                    {
                                                                                                            "Ref": "BlockId"
                                                                                                    },
                                                                                                    "-*"
                                                                                            ]
                                                                                    ]
                                                                            },
                                                                            {
                                                                                    "Fn::Join": [
                                                                                            "",
                                                                                            [
                                                                                                    "arn:aws:appstream:eu-west-1:",
                                                                                                    {
                                                                                                            "Ref": "AWS::AccountId"
                                                                                                    },
                                                                                                    ":image/",
                                                                                                    {
                                                                                                            "Ref": "BlockId"
                                                                                                    },
                                                                                                    "-*"
                                                                                            ]
                                                                                    ]
                                                                            }
                                                                    ]
                                                            },
{
              "Sid": "CodeCommitAccessPolicy",
              "Action": [
                "codecommit:BatchGet*",
                "codecommit:Get*",
                "codecommit:List*",
                "codecommit:CreateBranch",
                "codecommit:CreatePullRequest",
                "codecommit:DeleteBranch",
                "codecommit:Describe*",
                "codecommit:Put*",
                "codecommit:Post*",
                "codecommit:Merge*",
                "codecommit:Test*",
                "codecommit:Update*",
                "codecommit:GitPull",
                "codecommit:CancelUploadArchive",
                "codecommit:GitPush"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:codecommit:eu-west-1:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      ":",
                      {
                        "Ref": "BlockId"
                      },
                      "-*"
                    ]
                  ]
                }
              ]
            },
{
"Sid": "SSMAccessPolicy",
"Action": [
    "ssm:DeleteParameter",
    "ssm:DeleteParameters",
    "ssm:DescribeParameters",
    "ssm:GetParameter",
    "ssm:GetParameterHistory",
    "ssm:GetParameters",
    "ssm:GetParametersByPath",
    "ssm:PutParameter"
],
"Effect": "Allow",
"Resource": [
    {
        "Fn::Join": [
            "",
            [
                "arn:aws:ssm:eu-west-1:",
                {
                    "Ref": "AWS::AccountId"
                },
                ":parameter/",
                {
                    "Ref": "BlockId"
                },
                "-*"
            ]
        ]
    }
]
}
                                                    ]
                                            }
                                    }
                            ]
                    }
            },
            "BlockDeveloperCFNRole": {
                    "Type": "AWS::IAM::Role",
                    "Properties": {
                            "RoleName": {
                                    "Fn::Join": [
                                            "",
                                            [
                                                    {
                                                            "Ref": "BlockId"
                                                    },
                                                    "-dev-cfn"
                                            ]
                                    ]
                            },
                            "AssumeRolePolicyDocument": {
                                    "Statement": [
                                            {
                                                    "Action": "sts:AssumeRole",
                                                    "Effect": "Allow",
                                                    "Principal": {
                                                            "Service": "cloudformation.amazonaws.com"
                                                    }
                                            }
                                    ],
                                    "Version": "2012-10-17"
                            },
                            "ManagedPolicyArns": [
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-cfdeveloper-cf-access-policy"
                                                    ]
                                            ]
                                    },
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-cfdeveloper-ec2-rds-access-policy"
                                                    ]
                                            ]
                                    },
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-cfdeveloper-IAM-access-policy"
                                                    ]
                                            ]
                                    },
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-cfdeveloper-resources-access-policy"
                                                    ]
                                            ]
                                    },
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-developer-deny-VPC-only-policy"
                                                    ]
                                            ]
                                    },
                                    {
                                            "Fn::Join": [
                                                    "",
                                                    [
                                                            "arn:aws:iam::",
                                                            {
                                                                    "Ref": "AWS::AccountId"
                                                            },
                                                            ":policy/aab-cbsp-deny-update-stack"
                                                    ]
                                            ]
                                    }
                            ],
                            "Policies": [
                                    {
                                            "PolicyName": "inline-policy-cfn-block-role",
                                            "PolicyDocument": {
                                                    "Version": "2012-10-17",
                                                    "Statement": [
                                                            {
                                                                    "Sid": "NPAUserPolicy",
                                                                    "Action": [
                                                                            "iam:AttachGroupPolicy",
                                                                            "iam:DeleteGroupPolicy",
                                                                            "iam:DetachGroupPolicy",
                                                                            "iam:GetGroup",
                                                                            "iam:GetGroupPolicy",
                                                                            "iam:ListAttachedGroupPolicies",
                                                                            "iam:ListEntitiesForPolicy",
                                                                            "iam:ListGroupPolicies",
                                                                            "iam:PutGroupPolicy"
                                                                    ],
                                                                    "Effect": "Allow",
                                                                    "Resource": [
                                                                            {
                                                                                    "Fn::Join": [
                                                                                            "",
                                                                                            [
                                                                                                    "arn:aws:iam::",
                                                                                                    {
                                                                                                            "Ref": "AWS::AccountId"
                                                                                                    },
                                                                                                    ":group/",
                                                                                                    {
                                                                                                            "Ref": "BlockId"
                                                                                                    },
                                                                                                    "-NPA"
                                                                                            ]
                                                                                    ]
                                                                            }
                                                                    ]
                                                            }
                                                    ]
                                            }
                                    }
                            ]
                    }
            },
            "EntryRolePolicyForThisBlockRole": {
                    "Properties": {
                            "Description": "Policy for entry role to allow readonly",
                            "PolicyDocument": {
                                    "Statement": [
                                            {
                                                    "Action": [
                                                            "sts:AssumeRole"
                                                    ],
                                                    "Condition": {
                                                            "ForAnyValue:StringLike": {
                                                                    "saml:sub": {
                                                                            "Ref": "BlockMembersCorporateIds"
                                                                    }
                                                            }
                                                    },
                                                    "Effect": "Allow",
                                                    "Resource": [
                                                            {
                                                                    "Fn::Join": [
                                                                            "",
                                                                            [
                                                                                    "arn:aws:iam::",
                                                                                    {
                                                                                            "Ref": "AWS::AccountId"
                                                                                    },
                                                                                    ":role/",
                                                                                    {
                                                                                            "Ref": "BlockId"
                                                                                    },
                                                                                    "-dev"
                                                                            ]
                                                                    ]
                                                            }
                                                    ]
                                            }
                                    ],
                                    "Version": "2012-10-17"
                            },
                            "Roles": [
                                    "entry"
                            ]
                    },
                    "Type": "AWS::IAM::ManagedPolicy"
            }
    },
    "Outputs": {}
}